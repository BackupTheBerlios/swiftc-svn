#!/bin/bash

if [ $# -eq 0 ]; then
    echo "error: no input file given"
    exit -1
fi

in=$1
obj=$1.o
asm=$1.asm

#
# check options and shift parameters accordingly
#

if [ $# -eq 1 ]; then
    out=$1.out
    shift 1
elif [ $2 == "--" ]; then
    out=$1.out
    shift 2
elif [ $3 == "--" ]; then
    out=$2
    shift 3
else
    echo "usage: swiftc IN [OUT] [-- route-through-options]"
    exit -1
fi

./swift $in     # compile
as $asm -o $obj # assemble output

# compile lib.c if necessary
if [ ! -e 'test/lib.o' ]; then
    gcc -ggdb -c test/lib.c -o test/lib.o
fi

# and link everything
gcc -nostdlib -lc test/lib.o $obj -o $out $*
